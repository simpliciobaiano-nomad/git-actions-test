name: Dev Release & Auto-Tag

on:
  push:
    branches:
      - main
      - master
      - dev
      - release
    paths-ignore:
      - '**.md'

jobs:
 
  create-dev-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      new_tag: ${{ steps.versioning.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
      
      # --- RUN TESTS
      - name: Cache node_modules
        uses: actions/cache@v4
        id: node_modules_cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
           ${{ runner.os }}-node_modules-
      
      - name: Install dependencies
        if: steps.node_modules_cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Run test
        run: npm run test:cov     

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      # --- NOVO STEP: PRINT DA √öLTIMA TAG ---
      - name: Show Previous Tag
        # Tenta pegar a √∫ltima tag (suprimindo erros caso n√£o exista nenhuma)
        # '2>/dev/null' esconde mensagens de erro do git se for um repo novo
        # '||' define um valor padr√£o caso falhe
        run: |
          echo "Buscando √∫ltima tag existente no reposit√≥rio..."

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "Nenhuma tag encontrada (Primeira execu√ß√£o?)")
          
          echo "=============================================="
          echo "  √öLTIMA TAG ENCONTRADA: $LAST_TAG"
          echo "=============================================="

      - name: Generate Dev version & tag
        id: versioning

        run: |
          echo "=========================================="
          echo "GERANDO TAG DE DEV"
          echo "=========================================="
          
          # 1. Pega a vers√£o crua do arquivo
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "PACKAGE VERSION: $PKG_VERSION"
          
          # 2. Formata a Tag (Garante o padr√£o vX.Y.Z-DEV)
          # Remove o sufixo -DEV caso o dev j√° tenha colocado no package.json, para evitar duplica√ß√£o
          BASE_VERSION=$(echo $PKG_VERSION | sed 's/-DEV//')
          
          # Adiciona o padr√£o v...-DEV
          TARGET_TAG="v${BASE_VERSION}-DEV"
          echo "Tag Alvo para cria√ß√£o: $TARGET_TAG"
          
          echo "------------------------------------------"
          
          # 3. VALIDA√á√ÉO DE EXIST√äNCIA (O ponto chave)
          if git rev-parse "$TARGET_TAG" >/dev/null 2>&1; then
            echo "ERRO CR√çTICO: A tag '$TARGET_TAG' J√Å EXISTE no reposit√≥rio."
            echo "MOTIVO: A vers√£o no package.json ($PKG_VERSION) n√£o foi alterada desde o √∫ltimo release."
            echo "A√á√ÉO NECESS√ÅRIA: Atualize o package.json (ex: 1.0.1 -> 1.0.2) e fa√ßa um novo push."
            exit 1 # Quebra o workflow aqui
          else
            echo "Criando tag '$TARGET_TAG' .... "
          fi
          
          echo "------------------------------------------"
          
          # 4. Cria√ß√£o da Tag (Se chegou aqui, √© seguro)
          # O package.json n√£o precisa ser alterado (npm version) pois j√° lemos dele
          
          git tag $TARGET_TAG
          git push origin $TARGET_TAG
          
          echo "üéâ Tag $TARGET_TAG criada e enviada com sucesso!"
          
          # 5. Exporta para o pr√≥ximo job
          echo "version=$TARGET_TAG" >> $GITHUB_OUTPUT

       
       # 5. Build & Publica√ß√£o (SDK e Types)
     
      - name: Install Dependencies
        run: npm ci

      - name: Build SDK/Types
        run: npm run build

      - name: Publish to NPM (Prod/Latest)
        run: |
          # Publica como 'latest' (padr√£o)
          echo "FAKE - Publicando pacotes no NPM como 'latest'..."
          # npm publish --tag latest --workspaces
        # env:
        #   NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 6. Build & Publica√ß√£o (Docker)
      - name: Set up Docker Build
        # uses: docker/setup-buildx-action@v3
        run: |
          # Preparando setup docker
          echo "FAKE - Preparando setup docker"

      - name: Login to Docker (DEV)
        # uses: docker/login-action@v3
        # with:
        #   username: ${{ secrets.DOCKER_USERNAME }}
        #   password: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          # Login docker
          echo "FAKE - LOGIN DOCKER"

      - name: Build and Push Docker (DEV)
        # uses: docker/build-push-action@v5
        # with:
        #   context: .
        #   push: true
        #   # Gera duas tags: a vers√£o exata (v0.0.4) e a latest
        #   tags: |
        #     meurepo/minhaapp:${{ steps.calc.outputs.prod_tag }}
        #     meurepo/minhaapp:latest
        run: |
          # Build and Push Docker
          echo "FAKE - Build and Push Docker (DEV)"


  # -- REDUNDANT DESNECESSARIO --
  # run-tests:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     packages: write
  #   steps: 
  #     - name: Checkout code
  #       uses: actions/checkout@v4
    
  #     - name: Setup Node
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.x'
  #         registry-url: 'https://registry.npmjs.org'

  #     - name: Cache node_modules
  #       uses: actions/cache@v4
  #       id: node_modules_cache
  #       with:
  #         path: node_modules
  #         key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
  #         restore-keys: |
  #          ${{ runner.os }}-node_modules-
      
  #     - name: Install dependencies
  #       if: steps.node_modules_cache.outputs.cache-hit != 'true'
  #       run: npm ci

  #     - name: Run test
  #       run: npm run test
  #       run: npm run test:cov
