name: Utility - Check Latest Tag

# O gatilho 'workflow_dispatch' torna este workflow 100% manual via bot√£o
on: 
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout √© OBRIGAT√ìRIO
      # Sem baixar o c√≥digo (fetch-depth: 0), o runner n√£o "enxerga" as tags do Git.
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. Busca e Imprime a Tag
      - name: Print Latest Tag
        run: |
          echo "=========================================="
          echo "üîç Analisando reposit√≥rio..."
          echo "=========================================="
          
          # Comando git para buscar a √∫ltima tag criada (em qualquer branch)
          # 2>/dev/null: silencia erro se n√£o houver tags
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "NENHUMA_TAG_ENCONTRADA")
          
          # Pega o hash do commit dessa tag (para saber se √© velha ou nova)
          if [ "$LAST_TAG" != "NENHUMA_TAG_ENCONTRADA" ]; then
            TAG_COMMIT=$(git rev-list -n 1 $LAST_TAG)
            TAG_DATE=$(git log -1 --format=%cd --date=format:'%d/%m/%Y %H:%M' $TAG_COMMIT)
            
            echo ""
            echo "üè∑Ô∏è  √öLTIMA TAG PUBLICADA:  $LAST_TAG"
            echo "üìÖ  DATA DE CRIA√á√ÉO:       $TAG_DATE"
            echo "HASH:                  $TAG_COMMIT"
            echo ""
          else
             echo "‚ùå Nenhuma tag encontrada neste reposit√≥rio."
          fi
          
          echo "=========================================="
  
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: node_modules_cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
           ${{ runner.os }}-node_modules-
      
      - name: Install dependencies
        if: steps.node_modules_cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Run test
        run: npm run test