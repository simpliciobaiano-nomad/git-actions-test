name: Manual - Promote Dev to Prod

on:
  workflow_dispatch:
    inputs:
      dev_tag:
        description: 'Tag DEV para promover (ex: v0.0.4-DEV)'
        required: true
        type: string

jobs:
  promote-to-prod:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necess√°rio para criar tags
      packages: write  # Necess√°rio se usar GitHub Packages
    
    steps:
      # 1. Checkout (Baixa o hist√≥rico completo para ver as tags)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          ref: ${{ inputs.dev_tag }} # J√° baixa no commit da tag espec√≠fica

      # 2. Contexto (O print que voc√™ pediu)
      - name: Print Current Status
        run: |
          echo "=========================================="
          echo "üîç CONTEXTO DO REPOSIT√ìRIO"
          echo "=========================================="
          
          # Mostra a √∫ltima tag geral do repo
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "Nenhuma tag")
          echo "üè∑Ô∏è  √öltima tag existente no repo: $LAST_TAG"
          echo "üéØ  Tag selecionada para promo√ß√£o: ${{ inputs.dev_tag }}"
          echo "=========================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # --- RUN TESTS
      - name: Cache node_modules
        uses: actions/cache@v4
        id: node_modules_cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
           ${{ runner.os }}-node_modules-
      
      - name: Install dependencies
        if: steps.node_modules_cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Run test
        run: npm run test      


      - name: Configure Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 3. L√≥gica de Promo√ß√£o (Remove o sufixo -DEV)
      - name: Calculate Prod Version
        id: calc
        run: |
          DEV_TAG="${{ inputs.dev_tag }}"
          
          # Valida√ß√£o simples
          if [[ "$DEV_TAG" != *"-DEV"* ]]; then
            echo "‚ùå Erro: A tag informada ($DEV_TAG) n√£o parece ser uma tag DEV (n√£o tem o sufixo -DEV)."
            exit 1
          fi

          # Remove o sufixo -DEV (v0.0.4-DEV -> v0.0.4)
          PROD_TAG=$(echo $DEV_TAG | sed 's/-DEV//')
          
          # Remove o 'v' para usar no package.json (v0.0.4 -> 0.0.4)
          CLEAN_VERSION=$(echo $PROD_TAG | sed 's/^v//')
          
          echo "‚úÖ Transformando: $DEV_TAG  --->  $PROD_TAG"
          
          # Atualiza o package.json localmente para a vers√£o limpa
          # Isso garante que o artefato publicado no NPM tenha a vers√£o certa
          npm version $CLEAN_VERSION --no-git-tag-version --allow-same-version
          
          echo "prod_tag=$PROD_TAG" >> $GITHUB_OUTPUT

      # 4. Cria√ß√£o da Tag Git Oficial
      - name: Create & Push Prod Tag
        run: |
          PROD_TAG="${{ steps.calc.outputs.prod_tag }}"
          
          # Cria a tag PROD apontando para o mesmo commit da tag DEV
          git tag $PROD_TAG
          git push origin $PROD_TAG
          
          echo "üéâ Tag $PROD_TAG criada e enviada com sucesso!"

      # 5. Build & Publica√ß√£o (SDK e Types)
      - name: Install Dependencies
        run: npm ci

      - name: Build SDK/Types
        run: npm run build

      - name: Publish to NPM (Prod/Latest)
        run: |
          # Publica como 'latest' (padr√£o)
          echo "FAKE - Publicando pacotes no NPM como 'latest'..."
          # npm publish --tag latest --workspaces
        # env:
        #   NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 6. Build & Publica√ß√£o (Docker)
      - name: Set up Docker Buildx
        # uses: docker/setup-buildx-action@v3
        run: |
          # Preparando setup docker
          echo "FAKE - Preparando setup docker"

      - name: Login to Docker (Prod)
        # uses: docker/login-action@v3
        # with:
        #   username: ${{ secrets.DOCKER_USERNAME }}
        #   password: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          # Login docker
          echo "FAKE - LOGIN DOCKER"

      - name: Build and Push Docker (Prod)
        # uses: docker/build-push-action@v5
        # with:
        #   context: .
        #   push: true
        #   # Gera duas tags: a vers√£o exata (v0.0.4) e a latest
        #   tags: |
        #     meurepo/minhaapp:${{ steps.calc.outputs.prod_tag }}
        #     meurepo/minhaapp:latest
        run: |
          # Build and Push Docker
          echo "FAKE - Build and Push Docker (Prod)"
          